Select Distinct d.CREDealID,dealname,(CASE WHEN tblPIK.CREDealID is not null THEn 1 Else 0 end) IsPIKDeal,(CASE WHEN tbl_Y_Deal.dealid is not null THEn 'Y' Else 'N' end) UseRuletoDetermineNoteFunding,'exec [dbo].[usp_UpdateAutoRepayDataFromBackshopProduction] '''+d.CREDealID+''',''B0E6697B-3534-4C09-BE0A-04473401AB93'''from cre.Note ninner join cre.Deal d on n.DealID = d.DealIDinner join core.Account acc on acc.accountid = n.account_accountidleft join core.lookup l on l.lookupid = d.Statusleft JOin(Select Distinct credealid from(		Select Distinct d.CREDealID,dealname,		(CASE WHEN tblPIKNotes.credealid is not null then 1 else 0 end) as IsPIKDeal		from cre.Note n		inner join cre.Deal d on n.DealID = d.DealID		inner join core.Account acc on acc.accountid = n.account_accountid		left join core.lookup l on l.lookupid = d.Status		LEFT JOIN(			Select Distinct dealid,credealid 			from(				Select n.crenoteid,d.dealid,d.credealid,				(Select count(piks.StartDate) from Core.[PIKSchedule] piks				inner join core.Event e on e.EventID = piks.EventId				inner join core.Account acc on acc.AccountID = e.AccountID				where e.EventTypeID = 12 				and acc.AccountID = n.account_accountid) PIKScheduleCnt				from cre.Note n				inner join cre.Deal d on n.DealID = d.DealID				inner join core.Account acc on acc.accountid = n.account_accountid				where acc.isdeleted <> 1			)a			where PIKScheduleCnt > 0		)tblPIKNotes on tblPIKNotes.dealid = d.dealid		where d.isdeleted <> 1 and acc.IsDeleted <> 1 and n.ActualPayoffDate is null		and l.name = 'Active'	)z where z.IsPIKDeal = 1)tblPIK on tblPIK.CREDealID = d.credealidLeft Join(Select Distinct d.dealidfrom cre.Note ninner join cre.Deal d on n.DealID = d.DealIDwhere UseRuletoDetermineNoteFunding = 3)tbl_Y_Deal on tbl_Y_Deal.DealID = d.DealIDwhere d.isdeleted <> 1 and acc.IsDeleted <> 1 and n.ActualPayoffDate is nulland l.name = 'Active'